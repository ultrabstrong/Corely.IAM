@page "/permissions/{Id:guid}"
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@inherits EntityDetailPageBase
@inject IRetrievalService RetrievalService
@inject IDeregistrationService DeregistrationService

<PageTitle>Permission Detail - Corely IAM</PageTitle>

<div class="management-header">
    <h1><i class="bi bi-key me-2"></i>Permission <span class="resource-label">Detail</span></h1>
    <a href="@AppRoutes.Permissions" class="btn btn-outline-secondary btn-sm">Back to Permissions</a>
</div>

<Alert Message="@_message" Type="@_messageType" OnDismissed="() => _message = null" />

@if (_loading && _permission == null)
{
    <LoadingSpinner />
}
else if (_permission == null)
{
    <div class="alert alert-warning">Permission not found.</div>
}
else
{
    <div class="props-grid mb-3">
        <span class="prop-label">Resource Type</span>
        <span class="prop-value">@_permission.ResourceType</span>
        <span class="prop-label">Resource ID</span>
        <span class="prop-value">@(_permission.ResourceId == Guid.Empty ? "all" : _permission.ResourceId)</span>
        <span class="prop-label">Description</span>
        <span class="prop-value">@(_permission.Description ?? "â€”")</span>
        <span class="prop-label">CRUDX</span>
        <span class="prop-value">
            <span class="d-flex gap-2">
                <span class="permission-badge @(_permission.Create ? "active" : "inactive")">C</span>
                <span class="permission-badge @(_permission.Read ? "active" : "inactive")">R</span>
                <span class="permission-badge @(_permission.Update ? "active" : "inactive")">U</span>
                <span class="permission-badge @(_permission.Delete ? "active" : "inactive")">D</span>
                <span class="permission-badge @(_permission.Execute ? "active" : "inactive")">X</span>
            </span>
        </span>
    </div>

    <PermissionView Action="AuthAction.Delete" Resource="@PermissionConstants.PERMISSION_RESOURCE_TYPE" ResourceIds="new[] { Id }">
        <div class="danger-zone">
            <button class="btn btn-danger btn-sm" @onclick="ConfirmDelete" disabled="@_loading">Delete Permission</button>
        </div>
    </PermissionView>
}

<ConfirmModal @ref="_confirmModal" Title="Delete Permission" ConfirmText="Delete" OnConfirm="DeleteAsync" />

@code {
    private Permission? _permission;
    private ConfirmModal _confirmModal = null!;

    protected override async Task LoadCoreAsync()
    {
        var result = await RetrievalService.GetPermissionAsync(Id);
        if (result.ResultCode == RetrieveResultCode.Success && result.Item != null)
        {
            _permission = result.Item;
        }
    }

    private void ConfirmDelete()
    {
        if (_loading) return;
        _confirmModal.Show();
    }

    private async Task DeleteAsync()
    {
        await ExecuteSafeAsync(async () =>
        {
            var result = await DeregistrationService.DeregisterPermissionAsync(new DeregisterPermissionRequest(Id));
            if (result.ResultCode == DeregisterPermissionResultCode.Success)
            {
                NavigationManager.NavigateTo(AppRoutes.Permissions);
                return;
            }
            SetResultMessage(false, string.Empty, result.Message);
        });
    }
}
